<script>
  let isPlaying = false;
  let audioCtx, compressor, masterGain;
  let step = 0;
  let cosmicInterval = null;
  let activeOscillators = []; // TRACK ALL OSCILLATORS

  // === CLEANUP ===
  function stopAllOscillators() {
    activeOscillators.forEach(osc => {
      try { osc.stop(); } catch(e) {}
    });
    activeOscillators = [];
  }

  // === AUDIO SETUP ===
  async function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    compressor = audioCtx.createDynamicsCompressor();
    compressor.threshold.value = -24;
    compressor.knee.value = 12;
    compressor.ratio.value = 12;
    compressor.attack.value = 0.003;
    compressor.release.value = 0.2;
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 1.8;
    compressor.connect(masterGain);
    masterGain.connect(audioCtx.destination);
  }

  // === INSTRUMENTS (WITH TRACKING) ===
  function playKick() {
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(150, t);
    osc.frequency.exponentialRampToValueAtTime(40, t + 0.1);
    gain.gain.setValueAtTime(1.6, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
    osc.connect(gain).connect(compressor);
    osc.start(t); osc.stop(t + 0.4);
    activeOscillators.push(osc);
  }

  function playBass() {
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sawtooth';
    osc.frequency.value = 55;
    gain.gain.setValueAtTime(0.8, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
    osc.connect(gain).connect(compressor);
    osc.start(t); osc.stop(t + 0.3);
    activeOscillators.push(osc);
  }

  // ... same for playHiHat, playPluck, playPad, playShimmer, playKlonk ...

  // === START / PAUSE ===
  async function start() {
    if (isPlaying) return;
    await initAudio();
    cosmicInterval = setInterval(cosmicStep, 353);
    requestAnimationFrame(animate);
    isPlaying = true;
  }

  function pause() {
    if (!isPlaying) return;
    clearInterval(cosmicInterval);
    stopAllOscillators();
    isPlaying = false;
  }

  // === TAB VISIBILITY ===
  window.addEventListener('message', (e) => {
    if (e.data.action === 'tabHidden') pause();
    if (e.data.action === 'tabVisible' && isPlaying) start();
    if (e.data.action === 'unlocked') start();
    if (e.data.action === 'play' && !isPlaying) start();
    if (e.data.action === 'pause' && isPlaying) pause();
  });

  // === AUTO-START ===
  const check = setInterval(() => {
    if (window.top && window.top.audioUnlocked) {
      clearInterval(check);
      start();
    }
  }, 100);
</script>
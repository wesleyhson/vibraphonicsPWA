<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Neon Bar Synth</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body,html{width:100%;height:100%;overflow:hidden;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    canvas{display:block;flex:1;width:100%;}
    #overlay {
      position:absolute;top:0;left:0;width:100%;height:100%;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      background:rgba(0,0,0,0.8);z-index:10;color:#0f0;font-family:monospace;
    }
    #status {font-size:1.3rem;margin-bottom:1rem;}
    #unlock-btn {
      padding:16px 32px;background:#0f0;color:#000;border:none;border-radius:10px;
      font-size:1.1rem;font-weight:bold;cursor:pointer;
    }
    #overlay.hidden {display:none;}
  </style>
</head>
<body>

  <!-- UNLOCK OVERLAY -->
  <div id="overlay">
    <div id="status">Tap to unlock neon</div>
    <button id="unlock-btn">UNLOCK & VIBE</button>
  </div>

  <canvas id="bars"></canvas>

  <script>
    const overlay = document.getElementById('overlay');
    const status = document.getElementById('status');
    const unlockBtn = document.getElementById('unlock-btn');
    const canvas = document.getElementById('bars');
    const ctx = canvas.getContext('2d');
    
    let isPlaying = false;
    let animationId = null;

    // === LISTEN FOR PLAY/PAUSE FROM PARENT ===
    window.addEventListener('message', (e) => {
      if (e.data.action === 'play' && !isPlaying) startSynth();
      if (e.data.action === 'pause' && isPlaying) stopSynth();
    });

    // === RESIZE CANVAS ===
    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // === START SYNTH (WITH ERROR HANDLING) ===
    async function startSynth() {
      if (isPlaying) return;
      try {
        status.textContent = "Starting Tone.js...";
        await Tone.start();
        console.log('Tone.js ready');

        status.textContent = "Neon pulsing...";
        overlay.classList.add('hidden');

        Tone.Transport.bpm.value = 120;
        Tone.Transport.start();
        startLoops();
        animate();
        isPlaying = true;
      } catch (err) {
        console.error('Tone.js failed:', err);
        status.textContent = "Audio blocked. Tap again.";
        unlockBtn.textContent = "RETRY";
      }
    }

    // === STOP SYNTH ===
    function stopSynth() {
      if (!isPlaying) return;
      Tone.Transport.stop();
      if (animationId) cancelAnimationFrame(animationId);
      isPlaying = false;
      overlay.classList.remove('hidden');
      status.textContent = "Paused â€” tap to resume";
      unlockBtn.textContent = "RESUME";
    }

    // === TONE LOOPS ===
    function startLoops() {
      kickLoop.start(0);
      melodyLoop.start(0);
    }

    // === NEON BARS SETUP ===
    const barCount = 8;
    const barWidth = 40;
    const barSpacing = 80;
    let startX = (canvas.width - (barCount * barSpacing)) / 2 + 40;

    const colors = ['#ff004d','#ff6600','#ffcc00','#00ff66','#00ccff','#0066ff','#cc00ff','#ffffff'];
    const notes = ['C3','D3','E3','G3','A3','C4','D4','E4'];
    const heights = new Array(barCount).fill(0);
    const targets = new Array(barCount).fill(0);
    let kickPulse = 0;

    const synths = [];
    for (let i = 0; i < barCount; i++) {
      const synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "sine" },
        envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 0.4 }
      }).toDestination();
      synth.volume.value = -15;
      synths.push(synth);
    }

    const kick = new Tone.MembraneSynth({
      envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.1 }
    }).toDestination();

    const kickLoop = new Tone.Loop(t => kick.triggerAttackRelease("C1", "8n", t), "4n");
    const melodyLoop = new Tone.Loop(t => {
      const i = Math.floor(Math.random() * barCount);
      synths[i].triggerAttackRelease(notes[i], "8n", t);
      targets[i] = 1;
    }, "2n");

    const analyser = new Tone.Analyser("waveform", 32);
    kick.connect(analyser);

    // === ANIMATION LOOP ===
    function animate() {
      ctx.fillStyle = 'rgba(0,0,0,0.08)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const waveform = analyser.getValue();
      kickPulse = Math.max(kickPulse * 0.9, Math.abs(waveform[0] || 0));

      for (let i = 0; i < barCount; i++) {
        heights[i] += (targets[i] - heights[i]) * 0.2;
        if (heights[i] < 0.01) heights[i] = 0;
        targets[i] *= 0.95;
      }

      // Recalc startX on resize
      startX = (canvas.width - (barCount * barSpacing)) / 2 + 40;

      for (let i = 0; i < barCount; i++) {
        const x = startX + i * barSpacing;
        const maxH = canvas.height * 0.7;
        const h = maxH * heights[i] * (1 + kickPulse * 2);

        const gradient = ctx.createLinearGradient(x, canvas.height - h, x, canvas.height);
        gradient.addColorStop(0, colors[i]);
        gradient.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.fillStyle = gradient;
        ctx.shadowBlur = 30 + kickPulse * 60;
        ctx.shadowColor = colors[i];
        ctx.fillRect(x - barWidth/2, canvas.height - h, barWidth, h);

        ctx.fillStyle = colors[i];
        ctx.shadowBlur = 12;
        ctx.fillRect(x - 2, canvas.height - h, 4, h);
      }
      ctx.shadowBlur = 0;
      animationId = requestAnimationFrame(animate);
    }

    // === UNLOCK BUTTON ===
    unlockBtn.addEventListener('click', () => {
      if (isPlaying) stopSynth();
      else startSynth();
    });

    // Start silent animation
    animate();
  </script>
</body>
</html>